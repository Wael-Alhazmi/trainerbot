<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø±Ù‚Ù…ÙŠ â€“ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¨</title>

<style>
  body {
    font-family: "Tajawal", sans-serif;
    background: #F6F9F7;
    margin: 0;
    padding: 0;
    transition: 0.3s;
  }

  body.dark {
    background: #1a1a1a;
    color: white;
  }

  .header {
    background: #0A7A42;
    color: white;
    padding: 18px;
    font-size: 24px;
    text-align: center;
    font-weight: bold;
  }

  #floating-controls {
    position: fixed;
    top: 18px;
    right: 20px;
    display: flex;
    gap: 12px;
    z-index: 999999;
  }

  .round-btn {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    border: none;
    background: #0A7A42;
    color: white;
    font-size: 22px;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  }

  .mute-btn {
    background: #333;
  }

  #voiceBtn {
    background: #FFD000;
  }

  #chat-box {
    width: 90%;
    margin: 80px auto 20px auto;
    background: white;
    border-radius: 14px;
    padding: 15px;
    height: 460px;
    border: 2px solid #CFF5DD;
    overflow-y: auto;
  }

  body.dark #chat-box {
    background: #2b2b2b;
    border-color: #555;
  }

  .msg {
    margin: 12px 0;
    padding: 12px 16px;
    border-radius: 14px;
    max-width: 70%;
    line-height: 1.8;
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
  }

  .user-msg {
    background: #CFF5DD;
    margin-left: auto;
  }

  .bot-msg {
    background: #eee;
  }

  body.dark .user-msg {
    background: #0A7A42;
    color: white;
  }

  body.dark .bot-msg {
    background: #3a3a3a;
  }

  .controls {
    width: 90%;
    margin: auto;
    display: flex;
    gap: 10px;
  }

  input {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #aaa;
  }

  input.dark {
    background: #333;
    color: white;
    border-color: #777;
  }

  button.send {
    padding: 12px 20px;
    background: #0A7A42;
    color: white;
    border-radius: 10px;
    cursor: pointer;
    border: none;
  }

</style>
</head>

<body>

<div class="header">Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø±Ù‚Ù…ÙŠ â€“ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¨</div>

<!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
<div id="floating-controls">
  <button class="round-btn" onclick="toggleDark()">ğŸŒ™</button>
  <button class="round-btn mute-btn" id="muteBtn" onclick="toggleMute()">ğŸ”Š</button>
  <button class="round-btn" id="voiceBtn" onclick="startVoice()">ğŸ¤</button>
</div>

<div id="chat-box">
  <div class="bot-msg msg">Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙƒÙŠÙ Ø£Ø³ØªØ·ÙŠØ¹ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø£Ùˆ Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØª Ø£Ùˆ Ø§Ù„ÙÙˆØªÙˆØ´ÙˆØ¨ØŸ</div>
</div>

<div class="controls">
  <input id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§â€¦ Ø«Ù… Enter">
  <button class="send" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<script>
/* ========================= */
/*   ÙƒØªÙ…/ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø±Ø¯ÙˆØ¯     */
/* ========================= */
let soundEnabled = true;

function toggleMute() {
  soundEnabled = !soundEnabled;
  document.getElementById("muteBtn").textContent = soundEnabled ? "ğŸ”Š" : "ğŸ”‡";

  if (!soundEnabled) window.speechSynthesis.cancel();
}

function speak(text) {
  if (!soundEnabled) return;
  let msg = new SpeechSynthesisUtterance(text);
  msg.lang = "ar";
  window.speechSynthesis.speak(msg);
}

/* ========================= */
/*     Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ          */
/* ========================= */
function toggleDark() {
  document.body.classList.toggle("dark");
}

/* ========================= */
/*     Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ù„Ù€ Enter       */
/* ========================= */
document.getElementById("userInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});

/* ========================= */
/*      Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©         */
/* ========================= */
async function sendMessage() {
  const input = document.getElementById("userInput");
  const msg = input.value.trim();
  if (!msg) return;

  addMessage(msg, "user");
  input.value = "";

  const payload =
`Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©ØŒ Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØª Ø£ÙˆÙÙŠØ³ØŒ Ø§Ù„ÙÙˆØªÙˆØ´ÙˆØ¨.
Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø±Ø¯:
- Ù„Ø§ ØªØ²ÙŠØ¯ Ø¹Ù† 10 ÙƒÙ„Ù…Ø§Øª.
- Ø¨Ø¯ÙˆÙ† ØªØ±Ø­ÙŠØ¨.
- Ø£Ø³Ù„ÙˆØ¨ Ù…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­ ÙŠØ´Ø¨Ù‡ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¨.
- Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØ®ØµØµ: "Ø£Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆÙ…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØª ÙˆØ§Ù„ÙÙˆØªÙˆØ´ÙˆØ¨ ÙÙ‚Ø·."

Ø§Ù„Ø³Ø¤Ø§Ù„: ${msg}`;

  try {
    const response = await fetch("https://deepseek-server-ktuu.onrender.com/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({message: payload})
    });

    const data = await response.json();
    const reply = data.reply || "ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯.";

    addMessage(reply, "bot");
    speak(reply);

  } catch {
    addMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…", "bot");
  }
}

function addMessage(text, type) {
  const box = document.getElementById("chat-box");
  const div = document.createElement("div");
  div.className = type === "user" ? "msg user-msg" : "msg bot-msg";
  div.textContent = text;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* ========================= */
/*      ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª           */
/* ========================= */
let recognition;
let isListening = false;
let silenceTimer;

function startVoice() {
  if (isListening) { stopVoice(); return; }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = "ar-SA";
  recognition.interimResults = true;
  recognition.continuous = true;

  isListening = true;
  document.getElementById("voiceBtn").style.background = "#e60000";

  let finalTranscript = "";

  recognition.onresult = (event) => {
    let interim = "";

    for (let i=0; i<event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript;
      } else {
        interim += event.results[i][0].transcript;
      }
    }

    document.getElementById("userInput").value = finalTranscript + interim;

    resetSilenceTimer();
  };

  recognition.onerror = () => stopVoice();
  recognition.onend = () => stopVoice();

  recognition.start();
  resetSilenceTimer();
}

function resetSilenceTimer() {
  clearTimeout(silenceTimer);
  silenceTimer = setTimeout(() => {
    stopVoice();
    const msg = document.getElementById("userInput").value.trim();
    if (msg) sendMessage();
  }, 3000);
}

function stopVoice() {
  if (!isListening) return;
  isListening = false;

  try { recognition.stop(); } catch {}

  document.getElementById("voiceBtn").style.background = "#FFD000";
}
</script>

</body>
</html>
